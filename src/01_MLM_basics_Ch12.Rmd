# Multilevel linear models: the basics (Ch 12)

This chapter starts on page 251

```{r, include=FALSE, warning=F, message=F}
# knit options
knitr::opts_chunk$set(
  echo = TRUE
  , warning = FALSE
  , message = FALSE
  , results='hide'
  , fig.width = 10
  , fig.height = 7
)
# qualitative color pallette
my_color_pal_qual <- function(n) viridis::turbo(n = n * 4)[which(seq(1,n * 4,1) %% 4 == 0)]
```

## Setup

```{r, eval=T}
# bread-and-butter
library(tidyverse)
library(lubridate)
library(viridis)
library(scales)
library(latex2exp)
# visualization
library(cowplot)
library(kableExtra)
# Linear Mixed-Effects Models 
library(lme4)
# jags and bayesian
library(rjags)
library(MCMCvis)
library(HDInterval)
library(BayesNSF)
#set seed
set.seed(11)
```
 
## Load data

```{r}
srrs2 <- read.table ("../data/radon/srrs2.dat", header=TRUE, sep=",")
srrs2 %>% 
  dplyr::glimpse()
# filter MN and create vars
radon_mn <- srrs2 %>% 
  dplyr::filter(
    state=="MN"
  ) %>% 
  dplyr::mutate(
    radon = activity
    , log.radon = log(ifelse(radon==0, .1, radon))
    , y = log.radon
    , x = floor # 0 for basement, 1 for first floor
    , county_index = as.numeric(as.factor(county))
  )
# n
n <- nrow(radon_mn)
# count
radon_mn %>% dplyr::count(county_index, county) %>% dplyr::slice_head(n=10) %>% 
  kableExtra::kable(
    caption = "Records by county (first 10)"
  ) %>% 
  kableExtra::kable_styling(font_size = 12) %>% 
  kableExtra::column_spec(1, bold = FALSE, width = "3em")
```

## Varying-intercept model, no predictors (p. 253)

Partial-pooling estimates from a multilevel model: 
For this simple scenario with no predictors, the multilevel estimate for a given county $j$ can be approximated as a weighted average of the mean of the observations in the county (the unpooled estimate, $\overline{y}_j$) and the mean over all counties (the completely pooled estimate, $\overline{y}_{all}$):

### Data and Initial conditions

```{r}
# varying-intercept model, no predictors
## data for jags
data <- list(
  n = nrow(radon_mn)
  , J = radon_mn$county %>% unique() %>% length()
  , y = radon_mn$log.radon %>% as.double()
  , county = radon_mn$county_index %>% as.double()
)
## inits for jags
inits <- function(){
  list(
    alpha = rnorm(n = data$J, mean = 0, sd = 1) # county-level intercept (n = length of # counties)
    , mu.alpha = rnorm(n = 1, mean = 0, sd = 1)
    , sigma.alpha = runif(n = 1, min = 0, max = 1)
    , sigma.y = runif(n = 1, min = 0, max = 1)
  )
}
# define parameters to return from MCMC
params <- c ("alpha", "mu.alpha", "sigma.y", "sigma.alpha")
```

### JAGS Model

Write out the JAGS code for the model.

```{r, eval=FALSE}
## JAGS Model
model {
  ###########################
  # priors
  ###########################
  # alpha priors
    mu.alpha ~ dnorm(0, .0001)
    tau.alpha <- 1/sigma.alpha^2
    sigma.alpha ~ dunif(0, 100)
    for (j in 1:J){
      alpha[j] ~ dnorm(mu.alpha, tau.alpha)
    }
  # y priors
    sigma.y ~ dunif (0, 100)
    tau.y <- 1/sigma.y^2
  ###########################
  # likelihood
  ###########################
  for (i in 1:n){
    y[i] ~ dnorm(alpha[county[i]], tau.y)
  }
}
```

### Implement JAGS Model

```{r}
##################################################################
# insert JAGS model code into an R script
##################################################################
{ # Extra bracket needed only for R markdown files - see answers
  sink("intrcpt_nopred.R") # This is the file name for the jags code
  cat("
  ## JAGS Model
  model {
    ###########################
    # priors
    ###########################
    # alpha priors
      mu.alpha ~ dnorm(0, .0001)
      tau.alpha <- 1/sigma.alpha^2
      sigma.alpha ~ dunif(0, 100)
      for (j in 1:J){
        alpha[j] ~ dnorm(mu.alpha, tau.alpha)
      }
    # y priors
      sigma.y ~ dunif (0, 100)
      tau.y <- 1/sigma.y^2
    ###########################
    # likelihood
    ###########################
    for (i in 1:n){
      y[i] ~ dnorm(alpha[county[i]], tau.y)
    }
  }
  ", fill = TRUE)
  sink()
}
##################################################################
# implement model
##################################################################
######################
# Call to JAGS
######################
intrcpt_nopred = rjags::jags.model(
  file = "intrcpt_nopred.R"
  , data = data
  , inits = inits
  , n.chains = 3
  , n.adapt = 100
)
stats::update(intrcpt_nopred, n.iter = 1000, progress.bar = "none")
# save the coda object (more precisely, an mcmc.list object) to R
mlm_intrcpt_nopred = rjags::coda.samples(
  model = intrcpt_nopred
  , variable.names = params
  , n.iter = 1000
  , n.thin = 1
  , progress.bar = "none"
)
```

```{r, warning=FALSE, message=FALSE, echo=FALSE, include=FALSE}
remove(list = ls()[grep("_temp",ls())])
gc()
```

### Summary of the marginal posterior distributions of the parameters

```{r}
# summary
MCMCvis::MCMCsummary(mlm_intrcpt_nopred, params = params[params != "alpha"])
```

### Make a horizontal caterpillar plot for the $\alpha_{j}$

```{r}
# Caterpillar plots
MCMCvis::MCMCplot(
  mlm_intrcpt_nopred
  , params = c("alpha")
  , horiz = FALSE
  , ylim = c(-6,5)
  # Number specifying size of text for parameter labels on axis.
  , sz_labels = 0.6
  # Number specifying size of points represents posterior medians.
  , sz_med = 0.7
  # Number specifying thickness of 50 percent CI line (thicker line).
  , sz_thick = 2
  # Number specifying thickness of 95 percent CI line (thinner line).
  , sz_thin = 1
)
```

### Sort the $\alpha_{j}$ by number of obs.

Replicate Figure 12.1 (b) (p.253)

```{r}
dta_temp <- dplyr::bind_cols(
  radon_mn %>% dplyr::count(county_index) %>% data.frame()
  , MCMCvis::MCMCpstr(mlm_intrcpt_nopred, params = "alpha", func = function(x) quantile(x, c(0.25, 0.5, 0.75))) %>%
      data.frame() %>% 
      dplyr::rename_with(
        ~ tolower(gsub(".", "", .x, fixed = TRUE))
      )
  ) %>% 
  dplyr::arrange(n) %>% 
  dplyr::mutate(n_low_hi = dplyr::row_number() %>% as.factor())
ggplot(dta_temp) +
  geom_hline(
    yintercept = MCMCvis::MCMCpstr(mlm_intrcpt_nopred, params = "mu.alpha", func = median) %>% unlist()
    , linetype = "dashed"
    , lwd = 1
    , color = "gray40"
  ) +
  geom_point(
    mapping = aes(x = n_low_hi, y = alpha50)
  ) +
  scale_y_continuous(limits = c(0,3.2)) +
  ylab(latex2exp::TeX("$\\hat{\\alpha}_{j}$")) + 
  xlab("# Obs.") +
  theme_bw() + 
  theme(
    axis.text.x = element_blank()
  )
  
# median of predictions


## Figure 12.1 (b)

plot (sample.size.jittered, mlm.radon.nopred$median$a, cex.lab=.9, cex.axis=1,
      xlab="sample size in county j",
      ylab="avg. log radon in county j",
      pch=20, log="x", cex=.3, mgp=c(1.5,.5,0),
      ylim=c(0,3.2), yaxt="n", xaxt="n")
axis (1, c(1,3,10,30,100), cex.axis=.9, mgp=c(1.5,.5,0))
axis (2, seq(0,3), cex.axis=.9, mgp=c(1.5,.5,0))
for (j in 1:J){
  lines (rep(sample.size.jittered[j],2),
         mlm.radon.nopred$median$a[j] + c(-1,1)*mlm.radon.nopred$sd$a[j],
      lwd=.5)
}
abline(h=mlm.radon.nopred$median$mu.a)
points(sample.size.jittered[36],mlm.radon.nopred$median$a[36],cex=4)#,col="red")
title("Multilevel model",cex.main=.9, line=1)


```

